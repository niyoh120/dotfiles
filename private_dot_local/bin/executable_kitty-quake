#!/bin/bash

function kitty_quake() {
  HOMEBREW=/usr/local/bin
  QUAKE=($($HOMEBREW/yabai -m query --windows --space |jq '.[]|select(.title=="Quake")|.id,."is-minimized",."has-border",."has-focus"'))
  
  if [[ ${#QUAKE} -eq 0 ]]; then
    open -a kitty.app -n --args -1 --instance-group Quake --title Quake -o \
      tab_title_template="Quake: {index}" \
      &>/dev/null & disown; 
    while [[ ${#QUAKE[@]} -ne 4 ]];
      do
        QUAKE=($($HOMEBREW/yabai -m query --windows --space |jq '.[]|select(.title=="Quake")|.id,."is-minimized",."has-border",."has-focus"'))
      done
    $HOMEBREW/yabai -m window "${QUAKE[0]}" --toggle sticky;
    $HOMEBREW/yabai -m window "${QUAKE[0]}" --move abs:0:0;
    $HOMEBREW/yabai -m window "${QUAKE[0]}" --resize abs:10000:450;
    $HOMEBREW/yabai -m window "${QUAKE[0]}" --opacity 0.65;
  elif [[ ${QUAKE[3]} == false ]]; then
    [[ ${QUAKE[1]} == true ]] && ($HOMEBREW/yabai -m window "${QUAKE[0]}" --deminimize || :)
    $HOMEBREW/yabai -m window "${QUAKE[0]}" --move abs:0:0;
    $HOMEBREW/yabai -m window "${QUAKE[0]}" --resize abs:10000:450;
    $HOMEBREW/yabai -m window "${QUAKE[0]}" --opacity 0.65;
    $HOMEBREW/yabai -m window "${QUAKE[0]}" --focus "${QUAKE[0]}";
    [[ ${QUAKE[2]} == false ]] && ($HOMEBREW/yabai -m window "${QUAKE[0]}" --toggle border || :)
  elif [[ ${QUAKE[3]} == true ]]; then
    [[ ${QUAKE[2]} == false ]] && ($HOMEBREW/yabai -m window "${QUAKE[0]}" --toggle border || :)
    $HOMEBREW/yabai -m window "${QUAKE[0]}" --opacity 0.001;
    [[ ${QUAKE[1]} == false ]] && ($HOMEBREW/yabai -m window "${QUAKE[0]}" --minimize || :)
  else
    echo quake failed
  fi
}

kitty_quake